# 管理端新增接口文档

本文档主要说明万邦系统管理端新增的订单派送和司机审核相关接口。

## 基础信息

- 配送系统基础URL: `http://localhost:8000/api/` (通过代理 `/delivery-api` 访问)
- 请求格式: JSON
- 响应格式: JSON
- 鉴权方式: Bearer Token

## 通用响应格式

```json
{
  "code": 200,               // 状态码: 200成功, 400请求错误, 401未授权, 500服务器错误
  "message": "success",      // 状态描述
  "data": {                  // 响应数据
    // 具体响应数据
  }
}
```

## 接口代理配置

系统采用两套接口体系：一套用于主系统，另一套用于配送系统。相关代理配置如下：

```typescript
// vite.config.ts
{
  proxy: {
    // 主系统的代理
    '/api': {
      target: 'http://localhost:8080/api/',
      changeOrigin: true,
      rewrite: (path) => path.replace(/^\/api/, '')
    },
    // 配送系统的代理
    '/delivery-api': {
      target: 'http://localhost:8000/api/',
      changeOrigin: true,
      rewrite: (path) => path.replace(/^\/delivery-api/, '')
    }
  }
}
```

## 1. 订单派送相关接口

### 1.1 获取待派送订单列表

- **接口路径**: `/api/orders`
- **请求方式**: GET
- **功能说明**: 获取主系统中可以进行派送的订单列表
- **请求参数**: 

| 参数名 | 类型 | 是否必填 | 说明 |
|-------|-----|---------|------|
| page  | number | 否 | 页码，默认为1 |
| size  | number | 否 | 每页条数，默认为10 |
| orderNo | string | 否 | 订单编号 |
| customerPhone | string | 否 | 客户手机号 |
| status | string | 否 | 订单状态 |

- **响应数据**:

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "items": [
      {
        "id": 1,
        "order_no": "ORD202303150001",
        "customer_phone": "13900139000",
        "total_amount": 1500.00,
        "order_create_time": "2023-03-15T10:00:00.000Z",
        "delivery_status": 1,
        "order_remark": "客户要求下午送达"
      }
    ],
    "total": 10
  }
}
```

### 1.2 派送订单

- **接口路径**: `/delivery-api/delivery/dispatch`
- **请求方式**: POST
- **功能说明**: 创建派送订单
- **请求参数**:

```json
{
  "orderId": 1001,                       // 订单ID
  "deliveryAddress": "上海市浦东新区XX路",  // 配送地址
  "deliveryWeight": 2.5,                 // 配送重量(吨)
  "deliveryFee": 80.00,                  // 配送费用
  "deliveryRemark": "客户要求下午送达",     // 配送备注(可选)
  "operatorId": 10                       // 操作人ID
}
```

- **响应数据**:

```json
{
  "code": 200,
  "message": "派单成功",
  "data": {
    "id": 1,
    "order_id": 1001,
    "delivery_status": 2,
    "dispatch_time": "2023-03-15T15:30:00.000Z"
  }
}
```

### 1.3 获取派送状态

- **接口路径**: `/delivery-api/delivery/status/{orderId}`
- **请求方式**: GET
- **功能说明**: 获取订单派送状态
- **路径参数**:
  - orderId: 订单ID
- **响应数据**:

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "delivery_status": 2,                // 派送状态(1=待派单,2=待接单,3=配送中,4=已完成,5=已取消)
    "status_text": "待接单",              // 状态文本
    "dispatch_time": "2023-03-15T15:30:00.000Z", // 派单时间
    "driver_info": {                     // 司机信息(如有)
      "name": "张三",
      "phone": "13800138000"
    }
  }
}
```

### 1.4 更新派送状态

- **接口路径**: `/delivery-api/delivery/status/{deliveryId}`
- **请求方式**: PUT
- **功能说明**: 更新派送订单状态
- **路径参数**:
  - deliveryId: 派送ID
- **请求参数**:

```json
{
  "status": 3,       // 派送状态(1=待派单,2=待接单,3=配送中,4=已完成,5=已取消)
  "operatorId": 10   // 操作人ID
}
```

- **响应数据**:

```json
{
  "code": 200,
  "message": "状态更新成功",
  "data": {
    "id": 1,
    "delivery_status": 3
  }
}
```

### 1.5 取消派送

- **接口路径**: `/delivery-api/delivery/cancel/{deliveryId}`
- **请求方式**: POST
- **功能说明**: 取消派送订单
- **路径参数**:
  - deliveryId: 派送ID
- **请求参数**:

```json
{
  "operatorId": 10   // 操作人ID
}
```

- **响应数据**:

```json
{
  "code": 200,
  "message": "派送订单已取消",
  "data": {
    "id": 1,
    "delivery_status": 5,
    "cancel_time": "2023-03-15T16:30:00.000Z"
  }
}
```

## 2. 司机审核相关接口

### 2.1 获取待审核司机列表

- **接口路径**: `/delivery-api/driver/pending`
- **请求方式**: GET
- **功能说明**: 获取待审核的司机列表
- **请求参数**: 

| 参数名 | 类型 | 是否必填 | 说明 |
|-------|-----|---------|------|
| page  | number | 否 | 页码，默认为1 |
| size  | number | 否 | 每页条数，默认为10 |
| name  | string | 否 | 司机姓名 |
| phone | string | 否 | 手机号码 |
| status | number | 否 | 审核状态(1=待审核, 2=已审核, 3=已拒绝) |

- **响应数据**:

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "items": [
      {
        "id": 1001,
        "name": "张三",
        "phone": "13812345678",
        "status": 1,
        "license_number": "A12345678",
        "vehicle_type": "厢式货车",
        "registration_time": "2023-03-15T10:00:00.000Z"
      }
    ],
    "total": 5
  }
}
```

### 2.2 获取所有司机列表

- **接口路径**: `/delivery-api/driver/list`
- **请求方式**: GET
- **功能说明**: 获取所有司机列表
- **请求参数**: 与2.1相同
- **响应数据**: 格式与2.1相同

### 2.3 审核通过司机

- **接口路径**: `/delivery-api/driver/approve/{driverId}`
- **请求方式**: POST
- **功能说明**: 审核通过司机申请
- **路径参数**:
  - driverId: 司机ID
- **请求参数**:

```json
{
  "operator_id": 10,           // 操作人ID
  "remark": "审核通过备注"      // 备注信息(可选)
}
```

- **响应数据**:

```json
{
  "code": 200,
  "message": "司机审核通过成功",
  "data": {
    "id": 1001,
    "name": "张三",
    "status": 2,
    "approval_time": "2023-03-15T15:30:00.000Z"
  }
}
```

### 2.4 拒绝/删除司机

- **接口路径**: `/delivery-api/driver/{driverId}`
- **请求方式**: DELETE
- **功能说明**: 拒绝司机申请或删除司机
- **路径参数**:
  - driverId: 司机ID
- **响应数据**:

```json
{
  "code": 200,
  "message": "操作成功",
  "data": null
}
```

## 3. 前端类型定义

### 3.1 派送相关类型

```typescript
// 派送订单查询参数
export interface DeliveryQueryParams extends PaginationParams {
  orderNo?: string;
  customerPhone?: string;
  status?: string;
}

// 派送请求参数
export interface DispatchRequest {
  orderId: number;
  deliveryAddress: string;
  deliveryRemark?: string;
  deliveryWeight: number;
  deliveryFee: number;
  operatorId: number;
}

// 派送订单数据
export interface DeliveryOrder {
  id?: number;
  orderNo: string;
  orderId: number;
  customerPhone: string;
  deliveryAddress?: string;
  deliveryStatus?: number;
  dispatchTime?: string;
  driverId?: number;
  createTime?: string;
  updateTime?: string;
  orderRemark?: string;
  totalAmount?: number;
  orderCreateTime?: string;
}
```

### 3.2 司机相关类型

```typescript
// 司机查询参数
export interface DriverQueryParams extends PaginationParams {
  name?: string;
  phone?: string;
  status?: number; // 1=待审核, 2=已审核, 3=已拒绝
}

// 司机信息
export interface Driver {
  id: number;
  name: string;
  phone: string;
  status: number; // 1=待审核, 2=已审核, 3=已拒绝
  license_number?: string;
  vehicle_type?: string;
  registration_time?: string;
  approval_time?: string;
  remark?: string;
}

// 司机审核请求
export interface DriverApprovalRequest {
  operator_id: number;
  remark?: string;
}
```

## 4. API 调用示例

### 4.1 派送订单

```typescript
import { dispatchOrder } from '@/api/delivery';

// 派送订单
const handleDispatch = async () => {
  try {
    const response = await dispatchOrder({
      orderId: 1001,
      deliveryAddress: "上海市浦东新区XX路",
      deliveryWeight: 2.5,
      deliveryFee: 80.00,
      deliveryRemark: "客户要求下午送达",
      operatorId: 10
    });
    
    if (response.data && response.data.code === 200) {
      ElMessage.success('订单派送成功');
    } else {
      ElMessage.error(response.data?.message || '派送订单失败');
    }
  } catch (error) {
    console.error('派送订单时出错:', error);
    ElMessage.error('派送订单时出错');
  }
};
```

### 4.2 司机审核

```typescript
import { approveDriver } from '@/api/driver';

// 审核通过司机
const handleApprove = async (driverId: number) => {
  try {
    const response = await approveDriver(driverId, {
      operator_id: 10,
      remark: "审核通过备注"
    });
    
    if (response.status === 200 || response.status === 201) {
      ElMessage.success('司机审核通过成功');
    } else {
      ElMessage.error(response.data?.message || '审核失败');
    }
  } catch (error) {
    console.error('审核失败:', error);
    ElMessage.error('审核失败，请稍后重试');
  }
};
```
